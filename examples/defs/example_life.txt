/// title: game of life

/// code collapsed
// %collapsed
workshop([
  {
    title: 'Game of Life',
    content: md`This is a guided **workshop** for this notebook.
Use the **prev** and **next** buttons below to navigate
between pages, or click the progress dots to jump directly.

Close this panel with the **\u00d7** button. Reopen it
anytime with the **workshop** tab on the right edge
of the screen.`
  },
  {
    title: 'Manual cells',
    content: md`This entire notebook is a single
\`// %manual\` cell. Manual cells **don\u2019t re-run**
when upstream values change \u2014 they only execute
on **Ctrl+Enter** or **Run All**.

This is ideal for stateful simulations like Game of
Life, where you need persistent mutable state
(\`grid\`, \`gen\`) that survives between frames.`
  },
  {
    title: 'Imperative callbacks',
    content: md`The controls (step, play, reset) are plain
DOM buttons with \`onclick\` handlers. No reactive
widgets, no DAG overhead \u2014 just imperative JavaScript.

This pattern works when your UI is a tight loop:
\`step() \u2192 draw() \u2192 update label\`. Callbacks
mutate shared state directly, which is exactly what
the reactive model forbids in normal cells.`
  },
  {
    title: 'Canvas & invalidation',
    content: md`\`ui.canvas(w, h)\` creates a
\`<canvas>\` element in the cell\u2019s output. The cell
draws to it imperatively via \`getContext("2d")\`.

The \`invalidation\` promise resolves just before a
cell re-runs. Use it for cleanup:
\`invalidation.then(() => clearInterval(timer))\`.
Without this, re-running the cell would leak
intervals and canvases.`
  },
])

/// md
# conway's game of life

a cellular automaton running on canvas. press **step** or toggle **play** to watch it evolve. this is a single `// %manual` cell using imperative callbacks â€” no reactive DAG needed.

/// code
// %manual
const W = 80, H = 60;
let grid = new Uint8Array(W * H);
let gen = 0;

function seed(density) {
  for (let i = 0; i < grid.length; i++)
    grid[i] = Math.random() < density ? 1 : 0;
  gen = 0;
}
seed(0.3);

function step() {
  const next = new Uint8Array(W * H);
  for (let y = 0; y < H; y++) {
    for (let x = 0; x < W; x++) {
      let n = 0;
      for (let dy = -1; dy <= 1; dy++) {
        for (let dx = -1; dx <= 1; dx++) {
          if (dx === 0 && dy === 0) continue;
          n += grid[((y + dy + H) % H) * W + ((x + dx + W) % W)];
        }
      }
      const alive = grid[y * W + x];
      next[y * W + x] = (alive && (n === 2 || n === 3)) || (!alive && n === 3) ? 1 : 0;
    }
  }
  grid = next;
  gen++;
}

// renderer
const cellSize = Math.max(4, Math.min(8, Math.floor((window.innerWidth - 80) / W)));
const c = ui.canvas(W * cellSize, H * cellSize);
const ctx = c.getContext("2d");

function draw() {
  ctx.fillStyle = "#0a0a0a";
  ctx.fillRect(0, 0, c.width, c.height);
  ctx.fillStyle = "#c89b3c";
  for (let y = 0; y < H; y++)
    for (let x = 0; x < W; x++)
      if (grid[y * W + x])
        ctx.fillRect(x * cellSize, y * cellSize, cellSize - 1, cellSize - 1);
}
draw();

// controls
let playing = false, timer = null;
const genLabel = document.createElement("span");
genLabel.textContent = "generation: 0";

const btnStep = document.createElement("button");
btnStep.textContent = "step";
btnStep.onclick = () => { step(); draw(); genLabel.textContent = "generation: " + gen; };

const btnPlay = document.createElement("button");
btnPlay.textContent = "\u25b6 play";
btnPlay.onclick = () => {
  playing = !playing;
  btnPlay.textContent = playing ? "\u23f8 pause" : "\u25b6 play";
  if (playing) {
    timer = setInterval(() => {
      step(); draw();
      genLabel.textContent = "generation: " + gen;
    }, 80);
  } else clearInterval(timer);
};

const btnReset = document.createElement("button");
btnReset.textContent = "reset";
btnReset.onclick = () => {
  playing = false; clearInterval(timer);
  btnPlay.textContent = "\u25b6 play";
  seed(0.3); draw();
  genLabel.textContent = "generation: 0";
};

const bar = document.createElement("div");
bar.style.cssText = "display:flex;gap:8px;margin:8px 0;align-items:center";
bar.append(btnStep, btnPlay, btnReset, genLabel);
ui.display(bar);
