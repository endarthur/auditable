/// auditable
/// title: module playground

/// code collapsed
// %collapsed
workshop([
  {
    title: 'Module playground',
    content: md`This is a guided **workshop** for this notebook.
Use the **prev** and **next** buttons below to navigate
between pages, or click the progress dots to jump directly.

Close this panel with the **\u00d7** button. Reopen it
anytime with the **workshop** tab on the right edge
of the screen.`
  },
  {
    title: 'install() vs load()',
    content: md`\`install(url)\` fetches a module and
**embeds its source** in the HTML file on save.
After saving, the module loads instantly with no
network access. Use it for dependencies you need
offline.

\`load(url)\` imports a module at runtime from the
network. It\u2019s cached for the session but not
persisted. Use it for modules you\u2019re experimenting
with or that are too large to embed.`
  },
  {
    title: 'Offline capability',
    content: md`When you save a notebook with
\`install()\`-ed modules, the module source is stored
in the \`AUDITABLE-MODULES\` HTML comment block
(base64-encoded). The notebook becomes fully
self-contained.

Open a saved notebook on an airplane \u2014 installed
modules work. \`load()\`-ed modules will fail because
they need the network. This is the core trade-off:
embed size vs offline access.`
  },
  {
    title: 'Save persistence',
    content: md`Both \`install()\` and \`load()\` share the
same import cache (\`window._importCache\`). But only
\`install()\` writes to \`window._installedModules\`,
which gets serialized into the HTML on save.

The esm.sh URL gets \`?bundle\` appended automatically
so the module and its dependencies are bundled into
a single fetch. This keeps the installed module
self-contained.`
  },
])

/// md
# module playground

demonstrates `install()` for offline-capable module embedding and `load()` for on-demand imports. after saving, installed modules work without a network connection.

/// code
// install() fetches the module source and embeds it in the HTML on save.
// this means the notebook works offline after saving.
const { format, formatDistanceToNow } = await install("https://esm.sh/date-fns");

/// code
// load() imports a module at runtime (requires network).
// useful for modules you don't need offline.
const confetti = await load("https://esm.sh/canvas-confetti");

/// code
const dateStyle = ui.dropdown("format", ["full", "short", "relative"]);
const sampleDate = ui.textInput("date", "2024-07-20");

/// code
const d = new Date(sampleDate);
let formatted;
if (isNaN(d.getTime())) {
  formatted = "(invalid date)";
} else if (dateStyle === "full") {
  formatted = format(d, "EEEE, MMMM do, yyyy");
} else if (dateStyle === "short") {
  formatted = format(d, "MM/dd/yy");
} else {
  formatted = formatDistanceToNow(d, { addSuffix: true });
}
ui.display(formatted);

/// code
// confetti on demand
const fire = ui.checkbox("confetti", false);
if (fire) confetti.default({ particleCount: 120, spread: 80, origin: { y: 0.7 } });
